<!doctype html>
<html xmlns="http://www.w3.org/1999/html">
   <meta charset="utf-8">
   <head>
      <style>
          #containerSVG {
              margin-top: 5px;
              border: 1px solid black;
              width: 1900px;
              height: 840px;
              display: flex;
              flex-flow: row wrap;
          }

          div{
              margin: 2px;
          }
          .small{
              font: italic 12px "Arial";
              fill: black;
          }
          .active{
              fill: darkcyan;
          }
          #editor{
              justify-content: right;
          }
          #nums{
              padding: 5px;
              width: 1%;
              height: 98%;
              text-align: right;
          }
          .darkModeBody{
              background-color: gray;
              color: black;
          }
          .darkModeEditor{
              background-color: lightgray;
              color: black;
              border-color: lightgray;
          }
          .darkModeContainer{
              background-color: darkgrey;
          }

          /*  FOOTER */
          footer{
              background: lightslategray;
              border: 1px solid #7d87ff;
          }
          .footer-content{
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-wrap: wrap;
          }
          .about{
              width: 30%;
              color: white;
          }
      </style>
   </head>
   <body id="body">
      <div style="display: grid; grid-template-columns:1fr 1fr 1fr;">
         <div id="editor"  style="grid-row: 1 / span 3; grid-column: 1 / span 1; display: flex;">
            <div id="nums" class="small">1<br>2<br>3<br>4</div>
            <textarea class="darkmodeEditor" id="input" style=" width: 99%; height: 98%;">CREAVARn10
CREAVARi0
CREAVARa
ESCRIBEa0
ESCRIBEi1
DESTRUYE1
CREAVARa
ESCRIBEa1
IMPRIME6

ESCRIBEi2
DESTRUYE1
CREAVARa
ESCRIBEa2
IMPRIME7

ESCRIBEi3
DESTRUYE1
CREAVARa
ESCRIBEa3
ESCRIBEi4
DESTRUYE1
CREAVARa
ESCRIBEa4
IMPRIME9

ESCRIBEi5
DESTRUYE1
CREAVARa
ESCRIBEa5
IMPRIME10

ESCRIBEi6
DESTRUYE1
CREAVARa
ESCRIBEa6
ESCRIBEi7
DESTRUYE1
CREAVARa
ESCRIBEa7
DESTRUYE1
DESTRUYE1
CREAARRarr51,2,3,4,5
CREAVARi0
IMPRIME1 
ESCRIBEi1
IMPRIME2 
ESCRIBEi2
IMPRIME3 
ESCRIBEi3
IMPRIME4 
ESCRIBEi4
IMPRIME5 
ESCRIBEi5
DESTRUYE1
CREAARRbrr5
CREAVARa5
CREAVARa7
CREAVARa0
IMPRIME:(

DESTRUYE1
DESTRUYE1
CREAVARx0
ESCRIBEx1
CREAVARn2
IMPRIMEX2X
DESTRUYE1
ESCRIBEx2
CREAVARn2
IMPRIMEX2X
DESTRUYE1
ESCRIBEx3
CREAVARn2
IMPRIMEX2X
DESTRUYE1
ESCRIBEx4
		</textarea>
        </div>
        <div>
           <button id="btnGetText">Cargar Instrucciones / reniciar entorno</button>
		   <button id="btnDarkMode">Cambiar a modo oscuro</button>
        </div>
        <div>
           <button id="btnPrevInst" disabled>Ejecutar anterior</button>
           <button id="btnNextInst" disabled>Ejecutar siguiente</button>
        </div>
        <div>
           <button id="btnPlay" disabled>Reproducir</button>
           <label for="speed">Velocidad</label>
              <input type="range" id="speed" min="1" max="10" value="2">
           <button id="btnStop" disabled>Detener</button>
        </div>
		<div style="grid-row: 1 / span 3; grid-column: 2 / span 1; display: flex;">
			<textarea class="darkmodeEditor" id="output" disabled="true" style="width: 99%; height: 98%;"></textarea>
	    </div>
      </div>
      <svg id="containerSVG" class="darkmodeContaier">
      </svg>
   </body>
   <!--
   <footer id="footer">
      <div class="footer-content">
         <div class="about">
            <h2>Acerca del proyecto</h2>
         </div>
         <div >
            <a class="icons" target="_blank" href="https://www.linkedin.com/in/hernandezjosze">
               <img src="img/linkedin.png" width="50" height="50">
            </a>
            <a class="icons" target="_blank" href="mailto:josehdzg097@gmail.com">
               <img src="img/mail.png" width="60" height="50">
            </a>
            <a class="icons" target="_blank" href="https://github.com/HernandezJosze">
               <img src="img/git.png" width="50" height="50">
            </a>
         </div>
      </div>
   </footer>
   -->
   <script>
    let btnDark = document.getElementById('btnDarkMode');
    btnDark.addEventListener('click', ( ) => {
       document.getElementById('body').classList.toggle('darkModeBody');
       document.getElementById('containerSVG').classList.toggle('darkModeContainer');
       document.getElementById('input').classList.toggle('darkModeEditor');
       btnDark.innerText = btnDark.textContent === "Cambiar a modo oscuro" ? "Cambiar a modo claro" : "Cambiar a modo oscuro";
    });
    btnDark.click( );


    const posX = 30, posY = 30, tam = 60, container = document.getElementById("containerSVG");
    const MAX_X = 1900, MAX_Y = 840;
    let cx = posX, cy = posY;
	let instructions = [ ], currentInst = 0;
	let data = new Map( ), data_backup = new Map( );
	let stack = [], stack_backup = [];
	let text = "INPUT:\n", memoryText = [text];
    function cleanAll( ){
		cx = posX, cy = posY;
		instructions = [ ], currentInst = 0;
		data = new Map( ), data_backup = new Map( );
		stack = [], stack_backup = [];
		text = "INPUT:\n", memoryText = [text];
		document.getElementById('output').value = "INPUT:\n";
		while(container.hasChildNodes( )){
			container.removeChild(container.lastChild);
		}
    }

    function createSvg(type, svg_attributes, properties) {
       let node = document.createElementNS("http://www.w3.org/2000/svg", type);
       for (const name in svg_attributes) {
          node.setAttributeNS(null, name, svg_attributes[name]);
       }
       for (const name in properties) {
          node[name] = properties[name];
       }
       return node;
    }


    const btnGetText = document.getElementById('btnGetText');
	btnGetText.addEventListener('click', ( ) =>{
       cleanAll( );
       let line = document.getElementById('input').value.split('\04\n'); //separador de instruccion
       for(let instruction of line){
          instructions.push(instruction.split('\01'));// Separador de token
       }
       let ids = ["btnNextInst", "btnPlay"];
       for(let id of ids){
          document.getElementById(id).removeAttribute("disabled");
       }
       document.getElementById('btnPrevInst').setAttribute('disabled','');
    });

    function auxPlay( ){
       if(currentInst < instructions.length) {
          let timer = setTimeout(( ) => {
             executeNextInstruction( );
             auxPlay();
          }, 800 / parseInt(document.getElementById('speed').value));
          btnStop.onclick = ( ) => {
             clearTimeout(timer);
          };
       }else{
          btnStop.click( ); btnNext.click( );
       }
    }

    const btnPlay = document.getElementById('btnPlay');
    btnPlay.addEventListener('click', ( ) => {
       document.getElementById('btnStop').removeAttribute("disabled");
       const ids = ["btnNextInst","btnPrevInst", "btnPlay"];
       for(const id of ids){
          document.getElementById(id).setAttribute("disabled", '' );
       }
       auxPlay();
    });

    const btnStop = document.getElementById('btnStop');
    btnStop.addEventListener('click', function( ){
       this.setAttribute('disabled', '');
       const ids = ["btnNextInst","btnPrevInst", "btnPlay"];
       for(const id of ids){
          document.getElementById(id).removeAttribute("disabled");
       }
    });

    const btnNext = document.getElementById("btnNextInst");
    btnNext.addEventListener('click', ( ) => {
       if(currentInst < instructions.length) {
          executeNextInstruction();
          document.getElementById('btnPrevInst').removeAttribute('disabled');
       }
       if(currentInst === instructions.length){
          btnNext.setAttribute('disabled','');
       }
    });
 
	function wasArray(name){
		let index = name.indexOf("[");
		if(index === -1){
			return {'name': name, 'var': index};
		}else{
			const NAME = name.substr(0, index);
			let VAR = ''; ++index;
			while(name[index] !== "]"){
				VAR += name[index++];
			}
			return {'name': NAME, 'var': VAR};
		}
	}
	
    function executeNextInstruction( ){
		console.log(currentInst);
		const command = instructions[currentInst][0];   //command type/name name/value value
		if(command === "CREA"){
			const type = instructions[currentInst][1];
			const name = instructions[currentInst][2];
			stack.push({'name': name, 
						'version': 'v' + (data.has(name) ? data.get(name).length : 0)});
			if(!data.has(name)){
				data.set(name, []);
			}
			if (type === "ARR") {
				const tam = instructions[currentInst][3];
				const value = instructions[currentInst].length === 5 ? instructions[currentInst][4].split(',') : new Array();
				data.get(name).push({'tam': tam,
									 'vars': []});
				createArr(name, value);
			}else if(type === "VAR"){
				const value = instructions[currentInst].length === 4 ? instructions[currentInst][3] : '?';
				data.get(name).push({'tam': -1,
									 'values':[value]});
				createVar(name);
			}
		}else if (command === 'ESCRIBE') {
			const res = wasArray(instructions[currentInst][1]);//name
			const value = instructions[currentInst][2];
			const last = getLastPos(data.get(res.name));
			let id = '';
			if(res.var === -1){ // entonces es una variable
				data.get(res.name)[last].values.push(value);
				id = `${res.name}v${last}`;
			}else{ //es un arreglo
				data.get(res.name)[last].vars[res.var].values.push(value);
				id = `${res.name}v${last}[${res.var}]`;
			}
			 modifyBox(id, value);
		}else if(command === 'DESTRUYE'){
			let veces = instructions[currentInst][1];
			while(veces--){
				const variable = stack.pop( );
				stack_backup.push(variable);
				
				deleteVarArrOfHTML(variable.name, variable.version);
				if(!data_backup.has(variable.name)){
					data_backup.set(variable.name, []);
				}
				data_backup.get(variable.name).push(data.get(variable.name).pop( ));
			}
		}else if(command === 'IMPRIME'){
			const value = instructions[currentInst][1];
			text += value;
			memoryText.push(text);
			const textarea = document.getElementById('output');
			textarea.value  = text;
			textarea.scrollTop = textarea.scrollHeight;
		}
		currentInst++;
    }

    const btnPrev = document.getElementById('btnPrevInst');
    btnPrev.addEventListener('click', ( ) => {
       if(currentInst === 1){
          btnPrev.setAttribute('disabled','');
       }
       document.getElementById('btnNextInst').removeAttribute('disabled');
       backPrevInstruction( );
    });

    function backPrevInstruction( ){
		currentInst--;
		console.log(currentInst);
		const command = instructions[currentInst][0];
		if(command === "CREA"){
			const type = instructions[currentInst][1];
			const variable = stack.pop( );
			deleteVarArrOfHTML(variable.name, variable.version);
			data.get(variable.name).pop( );
		}else if(command === 'ESCRIBE'){
			const res = wasArray(instructions[currentInst][1]); //name
			const value = instructions[currentInst][2];
			const last = data.get(res.name).length - 1;
			let id = '';
			if(res.var === -1){// es var
				data.get(res.name)[last].values.push(value);
				id = `${res.name}v${last}`;
			}else{ // es array
				data.get(res.name)[last].vars[res.var].values.push(value);
				id = `${res.name}v${last}[${res.var}]`;
			}
			modifyBox(id, value);
       }else if(command === 'DESTRUYE'){
			let veces = instructions[currentInst][1];
			while(veces--){
				const variable = stack_backup.pop( );
				stack.push(variable);
				data.get(variable.name).push(data_backup.get(variable.name).pop( ));
				recovery(variable.name);
			}
		}else if(command === 'IMPRIME'){
			memoryText.pop( );
			document.getElementById('output').value = text = memoryText[memoryText.length - 1];
		}
    }
	
	function recovery(name){
		if(data.get(name)[getLastPos(data.get(name))].tam === -1){
			createVar(name);
		}else{
			createArr(name, [], false);
		}
	}
	
	function getLastPos(arr){
		return arr.length - 1;
	}
    function createArr(name, values, primera_vez = true){
		const num = data.get(name)[getLastPos(data.get(name))].tam;
		if(cx + tam + tam * num >= MAX_X){
			cx = posX;  cy += 150;
			if(cy >= MAX_Y || cx + tam * num + tam >= MAX_X){
				alert("El arreglo es demasiado grande");
				return;
			}
		}
		const realName = stack[getLastPos(stack)].name + stack[getLastPos(stack)].version;
		//Create the name of the array
		let node = createSvg("text", { "x": cx, "y": cy + 5 + tam / 2, "text-anchor": "middle", "class": "small"}, { "textContent": name + ':'});
		node.id = `svg|${realName}|`;
		container.appendChild(node);
		cx += tam / 2;

		//Create array
		if(primera_vez){
			const insert = (!values.length ? '?' : '0');
			while(values.length < num){
				values.push(insert);
			}
			for(let index = 0; index < num; ++index){
				createSpace(index, realName, values[index]);
				cx += tam;
				data.get(name)[getLastPos(data.get(name))].vars.push({'tam': -1,
																	  'values': [values[index]]});
			}
			cx += tam;
		}else{
			createArrAux(name);
		}
    }
	function createArrAux(name){
		const num = data.get(name)[getLastPos(data.get(name))].tam;
		const realName = stack[getLastPos(stack)].name + stack[getLastPos(stack)].version;
       //Create array
		for(let index = 0; index < num; ++index){
		const last = data.get(name)[getLastPos(data.get(name))].vars.length - 1;
		const lastV = data.get(name)[getLastPos(data.get(name))].vars[last].values.length - 1;
			createSpace(index, realName, data.get(name)[getLastPos(data.get(name))].vars[last].values[lastV]);
			cx += tam;
		}
		cx += tam;
	}
	function deleteVarArrOfHTML(name, version){
		const last = getLastPos(data.get(name));
		if(data.get(name)[last].tam === -1){
			deleteVar(name + version);
		}else{
			deleteArr(name + version, data.get(name)[last].tam);
		}
	}
    function deleteArr(name, num){
		document.getElementById(`svg|${name}|`).remove( );
		while(num > 0){
			num -= 1;
			const ids = [`svg|${name}[${num}]|box`, `svg|${name}[${num}]|value`, `svg|${name}[${num}]|name`];
			for(let id of ids) {
				document.getElementById(id).remove( );
			}
			cx -= tam;
		}
		cx = (cx - tam - tam / 2);
		repositionCY( );
    }

    function createVar(name){
		if(cx + tam >= MAX_X){
			cx = posX; cy += 150;
			if(cy >= MAX_Y){
				alert("Espacio lleno");
				return;
			}
		}
		const last = data.get(name).length - 1;
		const lastV = data.get(name)[last].values.length - 1;
		createSpace(name, '', data.get(name)[last].values[lastV]);
		cx += 2 * tam;
    }

    function deleteVar(name){
		const ids = [`svg|${name}|box`, `svg|${name}|value`, `svg|${name}|name`];
		for(const id of ids) {
			document.getElementById(id).remove( );
		}
		cx = cx - 2 * tam;
		repositionCY( );
    }

    function repositionCY( ){
		const child = document.getElementById('containerSVG').lastChild;
		if(cx === posX && child){
			cx = parseInt(child.getAttribute('x')) + tam + tam / 2;
			cy = cy !== 30 ? cy - 150 : cy;
		}
    }

    function createSpace(name, father, value){
		const realName = stack[getLastPos(stack)].name + stack[getLastPos(stack)].version;
		// Create variable's name
		let node, NAME = (father === '' ? `${realName}` : `${father}[${name}]`);
		let id = `svg|${NAME}|`;
		node = createSvg("text", { "x": cx + tam / 2, "y": cy + 15 + tam, "text-anchor":"middle", "class": "small"}, { "textContent": name });
		node.id = id + 'name';
		container.appendChild(node);

		//Create box variable
		node = createSvg('rect', { "x": cx, "y": cy, "width": tam, "height": tam, "fill": "lightgray", "stroke":"black"});
		node.id = id + 'box';
		container.appendChild(node);

		//Create content
		node = createSvg("text", { "x": cx + tam / 2, "y": cy + 5 + tam / 2, "text-anchor":"middle", "class": "small"});
		node.id = id + 'value';
		container.appendChild(node);
		modifyBox(NAME, value);		
    }


    let lastActive = undefined;
    function modifyBox(name, value) {
		let box = document.getElementById(`svg|${name}|box`), node = document.getElementById(`svg|${name}|value`);
		if (node) {
			node.textContent = value;
			if(lastActive) {
				lastActive.removeAttribute('class');
			}
			box.setAttribute('class','active');
			lastActive = box;
       }
    }
   </script>
</html>